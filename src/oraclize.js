var $ = require('jquery')
var ethJSABI = require('ethereumjs-abi')
var request = require('request')
var bs58 = require('bs58')
var cbor = require('cbor') //requires babel-polyfill

var generateOraclize = function (vmInstance,account) {
  vmInstance.executionContext.event.register('contextChanged', this, function (context) {
    if(context!='vm'){
      $('#oraclizeView').css("background-color","#FF9393")
      $('#oraclizeNotAvailable').show()
      $('#oraclizeVM').hide()
      $('#queryNotification').hide()
      $('#oraclizeWarning').show()
      $('#oraclizeImg').addClass("blackAndWhite")
    } else {
      $('#oraclizeWarning').hide()
      $('#oraclizeView').css("background-color","#F4F6FF")
      $('#oraclizeNotAvailable').hide()
      $('#oraclizeVM').show()
      generateOraclize(vmInstance,"0x265a5c3dd46ec82e2744f1d0e9fb4ed75d56132a")
    }
  })
  if(!vmInstance.executionContext.isVM()){
    $('#oraclizeView').css("background-color","#FF9393")
    $('#oraclizeNotAvailable').show()
    $('#oraclizeVM').hide()
    $('#queryNotification').hide()
    $('#oraclizeWarning').show()
    $('#oraclizeImg').addClass("blackAndWhite")
    return;
  } else {
    $('#oraclizeWarning').hide()
    $('#oraclizeView').css("background-color","#F4F6FF")
    $('#oraclizeNotAvailable').hide()
    $('#oraclizeVM').show()
  }

  if(typeof(vmInstance.accounts)=='undefined') return

  // remove oraclize account from the transaction tab
  $('#txorigin option[value="'+account+'"]').remove()

  var oar = ''
  var oraclizeConn = ''
  console.log('Deploying with account: '+account)
  var oraclizeConnector = '0x606060405260018054600160a060020a0319167326588a9301b0428d95e6fc3a5024fce8bec12d511790556404a817c80060055534610000575b60028054600160a060020a03191633600160a060020a03161790555b5b61254a806100656000396000f300606060405236156101855763ffffffff60e060020a6000350416630f82567381146101cc57806323dc42e7146102215780632ef3accc146102bf5780634536297814610326578063480a434d146103c3578063524f3889146103e25780635c242c591461044757806360f66701146104e757806362b3b8331461053c57806368742da614610591578063688dcfd7146105ac57806375700437146105c857806377228659146106685780637d242ae5146107435780637e1c42051461079957806380325b2d1461087657806381ade3071461032657806383eed3d5146109b357806385dee34c14610a5157806398cf6f2214610b2e578063a2ec191a14610bcb578063adf59f9914610221578063ae815843146105c8578063b5bfdd7314610d60578063bf1fe42014610dc6578063c281d19e14610dd8578063c51be90f14610e01578063c55c1cb614610ea1578063ca6ad1e414610f41578063d959701614610f53578063db37e42f14610fdd578063de4b326214611067578063e839e65e14611079575b34610000576101ca5b60025433600160a060020a039081169116148015906101bc575060015433600160a060020a03908116911614155b156101c657610000565b5b5b565b005b34610000576101ca600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375094965061115395505050505050565b005b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061121095505050505050565b60408051918252519081900360200190f35b34610000576102ad600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843750949650509335935061122b92505050565b60408051918252519081900360200190f35b6102ad600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061124195505050505050565b60408051918252519081900360200190f35b34610000576102ad61125c565b60408051918252519081900360200190f35b34610000576102ad600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375094965061126295505050505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061127692505050565b60408051918252519081900360200190f35b34610000576101ca600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375094965061159695505050505050565b005b34610000576101ca600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437509496506115f995505050505050565b005b34610000576101ca600160a060020a03600435166116b6565b005b34610000576101ca600160f860020a03196004351661171c565b005b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061174892505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061176195505050505050565b60408051918252519081900360200190f35b346100005760408051602060046024803582810135601f81018590048502860185019096528585526101ca958335959394604494939290920191819084018382808284375094965061177e95505050505050565b005b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061184692505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496505093359350611bd992505050565b60408051918252519081900360200190f35b6102ad600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061124195505050505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650611f1495505050505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496505093359350611f2f92505050565b60408051918252519081900360200190f35b6102ad600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650611f4a95505050505050565b60408051918252519081900360200190f35b34610000576101ca600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437509496505093359350611f6592505050565b005b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061121095505050505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061174892505050565b60408051918252519081900360200190f35b34610000576101ca600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375094965050600160f860020a031985351694602001359350611faa92505050565b005b34610000576101ca6004356120db565b005b3461000057610de561211d565b60408051600160a060020a039092168252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061212c92505050565b60408051918252519081900360200190f35b60408051602060046024803582810135601f81018590048502860185019096528585526102ad958335959394604494939290920191819084018382808284375050604080516020601f89358b01803591820183900483028401830190945280835297999881019791965091820194509250829150840183828082843750949650509335935061214592505050565b60408051918252519081900360200190f35b34610000576101ca60043561215e565b005b34610000576101ca600480803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843750506040805187358901803560208181028481018201909552818452989a99890198929750908201955093508392508501908490808284375094965061217d95505050505050565b005b34610000576101ca600480803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843750506040805187358901803560208181028481018201909552818452989a99890198929750908201955093508392508501908490808284375094965061221c95505050505050565b005b34610000576101ca6004356122d5565b005b6102ad600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375094965061239c95505050505050565b60408051918252519081900360200190f35b60025433600160a060020a03908116911614801590611181575060015433600160a060020a03908116911614155b1561118b57610000565b600060036000836040518082805190602001908083835b602083106111c15780518252601f1990920191602091820191016111a2565b51815160209384036101000a60001901801990921691161790526040805192909401829003909120865285019590955292909201600020805460ff1916941515949094179093555050505b5b50565b600061122184848462030d40611276565b90505b9392505050565b60006112388383336123b9565b90505b92915050565b60006112386000848462030d40611276565b90505b92915050565b60085481565b600061126e8233612505565b90505b919050565b6000600084836000600061128b8484336123b9565b91503482901061158357813403905060008111156112c957604051600160a060020a0333169082156108fc029083906000818181858888f150505050505b42624f1a00018a11806112db57504587115b156112e557610000565b600094508430336000600033600160a060020a0316600160a060020a031681526020019081526020016000205460405180851515151560f860020a02815260010184600160a060020a0316600160a060020a0316606060020a02815260140183600160a060020a0316600160a060020a0316606060020a028152601401828152602001945050505050604051809103902095506000600033600160a060020a0316600160a060020a03168152602001908152602001600020600081548092919060010191905055507fb76d0edd90c6a07aa3ff7a222d7f5933e29c6acc660c059c97837f05c4ca1a8433878c8c8c8c6006600033600160a060020a0316600160a060020a0316815260200190815260200160002060009054906101000a900460f860020a026007600033600160a060020a0316600160a060020a03168152602001908152602001600020546040518089600160a060020a0316600160a060020a031681526020018860001916600019168152602001878152602001806020018060200186815260200185600160f860020a031916600160f860020a03191681526020018481526020018381038352888181518152602001915080519060200190808383600083146114d1575b8051825260208311156114d157601f1990920191602091820191016114b1565b505050905090810190601f1680156114fd5780820380516001836020036101000a031916815260200191505b508381038252875181528751602091820191890190808383821561153c575b80518252602083111561153c57601f19909201916020918201910161151c565b505050905090810190601f1680156115685780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390a15b611588565b610000565b5b5050505050949350505050565b806040518082805190602001908083835b602083106115c65780518252601f1990920191602091820191016115a7565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091206004555050505b50565b60025433600160a060020a03908116911614801590611627575060015433600160a060020a03908116911614155b1561163157610000565b600160036000836040518082805190602001908083835b602083106111c15780518252601f1990920191602091820191016111a2565b51815160209384036101000a60001901801990921691161790526040805192909401829003909120865285019590955292909201600020805460ff1916941515949094179093555050505b5b50565b60025433600160a060020a039081169116148015906116e4575060015433600160a060020a03908116911614155b156116ee57610000565b604051600160a060020a0380831691309091163180156108fc02916000818181858888f150505050505b5b50565b33600160a060020a03166000908152600660205260409020805460ff191660f860020a83041790555b50565b600061175685858585611276565b90505b949350505050565b60006117568585858562030d40611846565b90505b949350505050565b60025460009033600160a060020a039081169116148015906117af575060015433600160a060020a03908116911614155b156117b957610000565b50600882905560005b600b5481101561183f57600a6000600b83815481101561000057906000526020600020900160005b50546000191660001916815260200190815260200160002054830260096000600b84815481101561000057906000526020600020900160005b505481526020810191909152604001600020555b6001016117c2565b5b5b505050565b6000600085836000600061185b8484336123b9565b915034829010611583578134039050600081111561189957604051600160a060020a0333169082156108fc029083906000818181858888f150505050505b42624f1a00018b11806118ab57504587115b156118b557610000565b600094508430336000600033600160a060020a0316600160a060020a031681526020019081526020016000205460405180851515151560f860020a02815260010184600160a060020a0316600160a060020a0316606060020a02815260140183600160a060020a0316600160a060020a0316606060020a028152601401828152602001945050505050604051809103902095506000600033600160a060020a0316600160a060020a03168152602001908152602001600020600081548092919060010191905055507faf30e4d66b2f1f23e63ef4591058a897f67e6867233e33ca3508b982dcc4129b33878d8d8d8d8d6006600033600160a060020a0316600160a060020a0316815260200190815260200160002060009054906101000a900460f860020a026007600033600160a060020a0316600160a060020a0316815260200190815260200160002054604051808a600160a060020a0316600160a060020a03168152602001896000191660001916815260200188815260200180602001806020018060200187815260200186600160f860020a031916600160f860020a031916815260200185815260200184810384528a818151815260200191508051906020019080838360008314611aa6575b805182526020831115611aa657601f199092019160209182019101611a86565b505050905090810190601f168015611ad25780820380516001836020036101000a031916815260200191505b5084810383528951815289516020918201918b01908083838215611b11575b805182526020831115611b1157601f199092019160209182019101611af1565b505050905090810190601f168015611b3d5780820380516001836020036101000a031916815260200191505b5084810382528851815288516020918201918a01908083838215611b7c575b805182526020831115611b7c57601f199092019160209182019101611b5c565b505050905090810190601f168015611ba85780820380516001836020036101000a031916815260200191505b509c5050505050505050505050505060405180910390a15b611bca565b610000565b5b505050505095945050505050565b60006000848360006000611bee8484336123b9565b9150348290106115835781340390506000811115611c2c57604051600160a060020a0333169082156108fc029083906000818181858888f150505050505b42624f1a00018a1180611c3e57504587115b15611c4857610000565b600094508430336000600033600160a060020a0316600160a060020a031681526020019081526020016000205460405180851515151560f860020a02815260010184600160a060020a0316600160a060020a0316606060020a02815260140183600160a060020a0316600160a060020a0316606060020a028152601401828152602001945050505050604051809103902095506000600033600160a060020a0316600160a060020a03168152602001908152602001600020600081548092919060010191905055507f3af7d71c651d8670228b02a0b636ffa73a7f759ef99ff9c024bc3b044a72443833878c8c8c8c6006600033600160a060020a0316600160a060020a0316815260200190815260200160002060009054906101000a900460f860020a026007600033600160a060020a0316600160a060020a03168152602001908152602001600020546040518089600160a060020a0316600160a060020a031681526020018860001916600019168152602001878152602001806020018060200186815260200185600160f860020a031916600160f860020a03191681526020018481526020018381038352888181518152602001915080519060200190808383600083146114d1575b8051825260208311156114d157601f1990920191602091820191016114b1565b505050905090810190601f1680156114fd5780820380516001836020036101000a031916815260200191505b508381038252875181528751602091820191890190808383821561153c575b80518252602083111561153c57601f19909201916020918201910161151c565b505050905090810190601f1680156115685780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390a15b611588565b610000565b5b5050505050949350505050565b60006112386000848462030d40611276565b90505b92915050565b600061122184848462030d40611bd9565b90505b9392505050565b6000611f3e8686868686611846565b90505b95945050505050565b60006112386000848462030d40611bd9565b90505b92915050565b611f7182600083611faa565b5b5050565b600061122184848462030d40611276565b90505b9392505050565b600061175685858585611276565b90505b949350505050565b60025460009033600160a060020a03908116911614801590611fdb575060015433600160a060020a03908116911614155b15611fe557610000565b83836040518083805190602001908083835b602083106120165780518252601f199092019160209182019101611ff7565b6001836020036101000a03801982511681845116808217855250505050505090500182600160f860020a031916600160f860020a0319168152600101925050506040518091039020905080600b600b80548091906001018154818355818115116120a5576000838152602090206120a59181019083015b808211156120a1576000815560010161208d565b5090565b5b505050815481101561000057906000526020600020900160005b50556000818152600a602052604090208290555b5b50505050565b60025433600160a060020a03908116911614801590612109575060015433600160a060020a03908116911614155b1561211357610000565b60058190555b5b50565b600154600160a060020a031681565b600061175685858585611748565b90505b949350505050565b600061175685858585611bd9565b90505b949350505050565b600160a060020a03331660009081526007602052604090208190555b50565b60025460009033600160a060020a039081169116148015906121ae575060015433600160a060020a03908116911614155b156121b857610000565b5060005b815181101561183f578281815181101561000057906020019060200201516007600084848151811015610000576020908102909101810151600160a060020a03168252810191909152604001600020555b6001016121bc565b5b5b505050565b60025460009033600160a060020a0390811691161480159061224d575060015433600160a060020a03908116911614155b1561225757610000565b5060005b815181101561183f5782818151811015610000579060200190602002015160f860020a02600660008484815181101561000057602090810291909101810151600160a060020a03168252810191909152604001600020805460ff191660f860020a9092049190911790555b60010161225b565b5b5b505050565b60025460009033600160a060020a03908116911614801590612306575060015433600160a060020a03908116911614155b1561231057610000565b50600881905560005b600b54811015611f7157600a6000600b83815481101561000057906000526020600020900160005b50546000191660001916815260200190815260200160002054820260096000600b84815481101561000057906000526020600020900160005b505481526020810191909152604001600020555b600101612319565b5b5b5050565b6000611221600085858562030d40611846565b90505b9392505050565b600160a060020a03811660009081526007602052604081205462030d4084118015906123e757506005548111155b8015612402575060015432600160a060020a03908116911614155b1561241057600091506124fd565b80151561241c57506005545b60045415801590612443575060045460009081526003602052604090205460ff1615156001145b1561245157600091506124fd565b600160a060020a03831660009081526006602090815260408083205490518851600994938a9360f860020a02929182918501908083835b602083106124a75780518252601f199092019160209182019101612488565b51815160001960209485036101000a01908116901991909116179052600160f860020a03199095169201918252506040805191829003600101909120855291840194909452919091016000205486840201935050505b509392505050565b60006112388362030d40846123b9565b90505b929150505600a165627a7a72305820ce73b7bfafd45a0e808001bb9006cff0db4a5ddad93084adea533d14395e51a00029'

  var oraclizeAddressResolver = '0x606060405260018054600160a060020a0319163317905560f3806100236000396000f3606060405260e060020a600035046338cc483181146038578063767800de146062578063a6f9dae1146073578063d1d80fdf146091575b005b600054600160a060020a03165b60408051600160a060020a03929092168252519081900360200190f35b6045600054600160a060020a031681565b603660043560015433600160a060020a0390811691161460af576002565b603660043560015433600160a060020a0390811691161460d1576002565b6001805473ffffffffffffffffffffffffffffffffffffffff19168217905550565b6000805473ffffffffffffffffffffffffffffffffffffffff1916821790555056'

  if(vmInstance.executionContext.isVM()){
    vmInstance.txRunner.rawRun({"from":account,"data":oraclizeConnector,"gasLimit":3000000}, function (err, result) {
      if(err) console.log(err);
      result = result.result
      var contractAddr = new Buffer(result.createdAddress).toString('hex')
      oraclizeConn = "0x"+contractAddr
      console.log("Generated connector: "+oraclizeConn)
      var setCbAddress = "0x9bb51487000000000000000000000000"+account.replace('0x','')
      vmInstance.txRunner.rawRun({"from":account,"to":oraclizeConn,"data":setCbAddress,"gasLimit":3000000}, function (err, result) {
        if(err) console.log(err);
        // OAR generate
        vmInstance.txRunner.rawRun({"from":account,"data":oraclizeAddressResolver,"gasLimit":3000000}, function (err, result) {
          if(err) console.log(err);
          result = result.result
          var resultAddr = new Buffer(result.createdAddress).toString('hex')
          oar = "0x"+resultAddr
          console.log("Generated oar: "+oar)
          var setAddr = "0xd1d80fdf000000000000000000000000"+(oraclizeConn.replace('0x',''))
          vmInstance.txRunner.rawRun({"from":account,"to":oar,"data":setAddr,"gasLimit":3000000}, function (err, result) {
            if(err) console.log(err);
            $('#oraclizeStatus').html('<span class="green">READY</span>')
            $('#oraclizeImg').removeClass("blackAndWhite")
            runLog(vmInstance,oraclizeConn)
          })
        })
      })
    })

    function runLog(vmInstance,connectorAddr){
      vmInstance.vm.on('afterTx', function (response) {
        for (var i in response.vm.logs) {
          var log = response.vm.logs[i]
          var decoded
          var log = response.vm.logs[i]
          if("0x"+log[0].toString('hex')==connectorAddr){
            var eventSignature = log[1][0].toString('hex')
            if(eventSignature=="b76d0edd90c6a07aa3ff7a222d7f5933e29c6acc660c059c97837f05c4ca1a84"){ // Log1 signature
              var types = ["address","bytes32","uint256","string","string","uint256","bytes1","uint256"] // event Log1
              decoded = ethJSABI.rawDecode(types, log[2])
              decoded = ethJSABI.stringify(types, decoded)
              decoded = {"sender":decoded[0],"cid":decoded[1],"timestamp":decoded[2],"datasource":decoded[3],"arg":decoded[4],"gaslimit":decoded[5],"proofType":decoded[6],"gasPrice":decoded[7]}
            } else if(eventSignature=="af30e4d66b2f1f23e63ef4591058a897f67e6867233e33ca3508b982dcc4129b"){ // Log2 signature
              var types = ["address","bytes32","uint256","string","string","string","uint256","bytes1","uint256"] // event Log2
              decoded = ethJSABI.rawDecode(types, log[2])
              decoded = ethJSABI.stringify(types, decoded)
              decoded = {"sender":decoded[0],"cid":decoded[1],"timestamp":decoded[2],"datasource":decoded[3],"arg1":decoded[4],"arg2":decoded[5],"gaslimit":decoded[6],"proofType":decoded[7],"gasPrice":decoded[8]}
            } else if(eventSignature=="3af7d71c651d8670228b02a0b636ffa73a7f759ef99ff9c024bc3b044a724438"){ // LogN signature
              var types = ["address","bytes32","uint256","string","bytes","uint256","bytes1","uint256"] // event LogN
              decoded = ethJSABI.rawDecode(types, log[2])
              decoded = ethJSABI.stringify(types, decoded)
              decoded = {"sender":decoded[0],"cid":decoded[1],"timestamp":decoded[2],"datasource":decoded[3],"args":decoded[4],"gaslimit":decoded[5],"proofType":decoded[6],"gasPrice":decoded[7]}
            }
            if(!$('#queryHistoryContainer').find('.datasource').length) $('#queryHistoryContainer').html('');
            console.log(decoded)
            var myid = decoded['cid']
            var myIdInitial = myid
            var cAddr = decoded['sender']
            var ds = decoded['datasource']
            if(typeof(decoded['arg']) != 'undefined'){
              var formula = decoded['arg']
            } else if(typeof(decoded['args']) != 'undefined') {
              var formula = cbor.decodeAllSync(new Buffer(decoded['args'].substr(2), 'hex'))[0]
            } else {
              var arg2formula = decoded['arg2']
              var formula = [decoded['arg1'],arg2formula]
            }
            if($('#query_'+myIdInitial).length!=0){
              return
            }
            var dateQuery = new Date()
            dateQuery = dateQuery.getHours()+":"+dateQuery.getMinutes()+":"+dateQuery.getSeconds()
            var queryInfoTitle = "Time: "+dateQuery+"\n"+"myid: "+myIdInitial
            var queryHtml = "<div id='query_"+myIdInitial+"' title='"+queryInfoTitle+"' style='margin-bottom:4px;'><span><span class='datasource'>"+ds+"</span> "+formula+"</span><br></div>"
            $('#queryHistoryContainer').append(queryHtml)

            var time = parseInt(decoded['timestamp'])
            var gasLimit = parseInt(decoded['gaslimit'])
            var proofType = decoded['proofType']
            var query = {
                when: time,
                datasource: ds,
                query: formula,
                proof_type: parseInt(proofType)
            }
            console.log(formula)
            console.log(JSON.stringify(query))
            createQuery(query, function(data){
              console.log("Query : "+data)
              data = JSON.parse(data)
              myid = data.result.id
              console.log("New query created, id: "+myid)
              console.log("Checking query status every 5 seconds..")
              updateQueryNotification(1);
              var interval = setInterval(function(){
                // check query status
                checkQueryStatus(myid, function(data){
                  data = JSON.parse(data)
                  console.log("Query result: "+JSON.stringify(data))
                  if(data.result.checks==null) return;
                  var last_check = data.result.checks[data.result.checks.length-1]
                  var query_result = last_check.results[last_check.results.length-1]
                  var dataRes = query_result
                  var dataProof = data.result.checks[data.result.checks.length-1]['proofs'][0]
                  if (!last_check.success) return;
                  else clearInterval(interval)
                  if(dataProof==null && proofType!='0x00'){
                    dataProof = new Buffer('')
                  } else if(typeof dataProof == 'object' && proofType!='0x00'){
                    if(typeof dataProof.type != 'undefined' && typeof dataProof.value != 'undefined'){
                      dataProof = new Buffer(dataProof.value)
                    }
                  }
                  oraclizeCallback(vmInstance, account, gasLimit, myIdInitial, dataRes, dataProof, cAddr)
                })

              }, 5*1000)
            })
          }
        }
      })
    }
    function oraclizeCallback(vmInstance, mainAccount, gasLimit, myid, result, proof, contractAddr){
      if(proof==null){
        var callbackData = ethJSABI.rawEncode(["bytes32","string"],[myid,result]).toString('hex')
        vmInstance.txRunner.rawRun({"from":mainAccount,"to":contractAddr,"gasLimit":gasLimit,"value":0,"data":"0x27dc297e"+callbackData}, function(e, tx){
          var resultTx = tx
          tx = tx.result
          if(e || tx.vm.exceptionError){
            var error = e || tx.vm.exceptionError
            var $button = $('<div class="debugTx"><button title="Launch Debugger" class="debug"><i class="fa fa-bug"></i></div></div>');
            result = '<span style="color:#F00;">'+error+'</span>'
            $button.click(function(){
              vmInstance.event.trigger("debugRequested",[resultTx])
            })
            console.log(error)
          }
          $('#query_'+myid).append('<span class="queryResult">=</span> '+result)
          if($button) $('#query_'+myid).append($button)
        })
      } else {
        var inputProof = (proof.length==46) ? bs58.decode(proof) : proof
        var callbackData = ethJSABI.rawEncode(["bytes32","string","bytes"],[myid,result,inputProof]).toString('hex')
        vmInstance.txRunner.rawRun({"from":mainAccount,"to":contractAddr,"gasLimit":gasLimit,"value":0,"data":"0x38BBFA50"+callbackData}, function(e, tx){
          var resultTx = tx
          tx = tx.result
          if(e || tx.vm.exceptionError){
            var error = e || tx.vm.exceptionError
            var $button = $('<div class="debugTx"><button title="Launch Debugger" class="debug"><i class="fa fa-bug"></i></div></div>');
            result = '<span style="color:#F00;">'+error+'</span>'
            $button.click(function(){
              vmInstance.event.trigger("debugRequested",[resultTx])
            })
            console.log(error)
          }
          $('#query_'+myid).append('<span class="queryResult">=</span> '+result+'<br><span style="color:#666;">Proof:</span> '+proof)
          if($button) $('#query_'+myid).append($button)
        })
          console.log('proof: '+proof)
      }
      updateQueryNotification(1)
      console.log('myid: '+myid)
      console.log('result: '+result)
      console.log('Contract '+contractAddr+ ' __callback called')
    }

    function updateQueryNotification(count){
      var activeTab = $('#optionViews').attr('class')
      $('#oraclizeWarning, #oraclizeAdditionalWarning').hide()
      if(activeTab!='oraclizeView'){
        $('#queryNotification').show()
        $('#queryNotification').html(count+parseInt($('#queryNotification').text()))
      }
    }

    $('.oraclizeView').on('click', function(e){
      e.preventDefault()
      $('#queryNotification').hide()
      $('#queryNotification').html('0')
    })

    $('.clearQueries').on('click', function(e){
      e.preventDefault()
      $('#queryHistoryContainer').html('')
    })

  }
}

function createQuery(query, callback){
  request.post('https://api.oraclize.it/v1/query/create', {body: JSON.stringify(query), headers:{"X-User-Agent":"browser-solidity","Content-Type":"application/json"} }, function (error, response, body) {
    if (error) console.log(error)
    if (response.statusCode == 200) {
      callback(body)
    } else {
      $('#oraclizeAdditionalWarning').show()
      $('#oraclizeWarning').show()
      $('#queryNotification').hide()
    }
  })
}

function checkQueryStatus(query_id, callback){
  request.get('https://api.oraclize.it/v1/query/'+query_id+'/status', { headers:{"X-User-Agent":"browser-solidity","Content-Type":"application/json"} }, function (error, response, body) {
    if (error) console.log(error)
    if (response.statusCode == 200) {
      callback(body)
    } else {
      $('#oraclizeAdditionalWarning').show()
      $('#oraclizeWarning').show()
      $('#queryNotification').hide()
    }
  })
}


module.exports = {
  'generateOraclize': generateOraclize
}
